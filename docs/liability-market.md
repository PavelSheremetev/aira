## Рынок обязательств

[[Source code]](https://github.com/airalab/core/blob/master/contracts/market/LiabilityMarket.sol)
[[API Reference]](http://airalab.github.io/core/docs/docs/LiabilityMarket/)

Требования:

1. торгуются только обязательства одного *рода*;
2. гарантируется, что после заключения сделки инстанцируется контракт обязательства;
3. контракт всегда знает разность между лучшими ценами покупки и продажи;

### Структуры данных

Для выполнения требования [3] используется сортирующее бинарное дерево.

Структура бинарной кучи `asks` - `MaxHeap` (для `bids` будет `MinHeap`):

![heapstructure](https://cloud.githubusercontent.com/assets/786394/25269945/6a40d246-2687-11e7-8989-8546ba55b93f.png)

# 

Добавление элемента:

1. элемент добавляется в конец списка;
2. вызывается операция восстановления свойств кучи (`heapify`).

![heapinsert](https://cloud.githubusercontent.com/assets/786394/25270669/14cd37b6-268a-11e7-9fad-c0220869448a.png)

Удаление элемента:

1. на место удаляемого элемента помещается элемент из конца списка;
2. вызывается операция восстановления свойств кучи (`heapify`).

![heapdelete](https://cloud.githubusercontent.com/assets/786394/25270633/fd3f7294-2689-11e7-9576-21920366ef81.png)

# 

Восстанавление свойств кучи `heapify`.

Свойства бинарной кучи:

1. Значение в любой вершине не меньше(больше), чем значения её потомков.
2. Глубина всех листьев (расстояние до корня) отличается не более чем на 1 слой.
3. Последний слой заполняется слева направо без «дырок».

![heaps_heapify](https://cloud.githubusercontent.com/assets/786394/25270153/3aad0792-2688-11e7-88c0-ce183ad7cada.png)

